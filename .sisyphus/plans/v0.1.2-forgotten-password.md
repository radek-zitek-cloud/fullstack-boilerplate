# Implementation Plan: v0.1.2 Patch - Forgotten Password Reset

## TL;DR

**Scope**: Complete forgotten password reset flow with email
**Effort**: Medium-High (8-10 tasks)
**Breaking Changes**: None (database migration required)
**Dependencies**: Email service (SMTP) configuration

---

## What We'll Implement

### Backend
- Password reset token generation and storage
- Email sending with reset link
- Token validation and password reset endpoint
- Token expiration (24 hours)

### Frontend
- "Forgot password?" link on login page
- Request reset page (enter email)
- Reset password page (enter new password with token)
- Success/error notifications

### Email
- HTML email template with reset link
- Plain text fallback
- Professional styling matching the app

---

## Database Schema

### New Table: password_reset_tokens
```sql
CREATE TABLE password_reset_tokens (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    user_id INTEGER NOT NULL,
    token VARCHAR(255) NOT NULL UNIQUE,
    expires_at TIMESTAMP NOT NULL,
    used BOOLEAN DEFAULT FALSE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE
);

CREATE INDEX idx_reset_tokens_token ON password_reset_tokens(token);
CREATE INDEX idx_reset_tokens_expires ON password_reset_tokens(expires_at);
```

---

## Backend Tasks

### Task 1: Create PasswordResetToken model
**File**: `backend/app/models/password_reset_token.py`

```python
class PasswordResetToken(Base, TimestampMixin):
    __tablename__ = "password_reset_tokens"
    
    id: Mapped[int] = mapped_column(Integer, primary_key=True)
    user_id: Mapped[int] = mapped_column(Integer, ForeignKey("users.id"), nullable=False)
    token: Mapped[str] = mapped_column(String(255), unique=True, nullable=False, index=True)
    expires_at: Mapped[datetime] = mapped_column(DateTime, nullable=False)
    used: Mapped[bool] = mapped_column(Boolean, default=False)
    
    user: Mapped["User"] = relationship("User", back_populates="reset_tokens")
```

### Task 2: Create Alembic migration
```bash
cd backend && uv run alembic revision --autogenerate -m "Add password_reset_tokens table"
```

### Task 3: Create schemas
**File**: `backend/app/schemas/auth.py` (additions)

```python
class ForgotPasswordRequest(BaseModel):
    email: EmailStr

class ResetPasswordRequest(BaseModel):
    token: str
    new_password: str = Field(..., min_length=8)
```

### Task 4: Create password reset service
**File**: `backend/app/services/password_reset.py`

```python
import secrets
from datetime import datetime, timedelta

async def create_reset_token(user_id: int, db: AsyncSession) -> str:
    """Create a new password reset token."""
    token = secrets.token_urlsafe(32)
    expires_at = datetime.utcnow() + timedelta(hours=24)
    
    reset_token = PasswordResetToken(
        user_id=user_id,
        token=token,
        expires_at=expires_at,
    )
    db.add(reset_token)
    await db.commit()
    
    return token

async def validate_reset_token(token: str, db: AsyncSession) -> Optional[User]:
    """Validate a reset token and return the user if valid."""
    result = await db.execute(
        select(PasswordResetToken)
        .where(
            PasswordResetToken.token == token,
            PasswordResetToken.expires_at > datetime.utcnow(),
            PasswordResetToken.used == False
        )
        .options(selectinload(PasswordResetToken.user))
    )
    reset_token = result.scalar_one_or_none()
    
    if reset_token:
        return reset_token.user
    return None

async def mark_token_used(token: str, db: AsyncSession) -> None:
    """Mark a reset token as used."""
    result = await db.execute(
        select(PasswordResetToken).where(PasswordResetToken.token == token)
    )
    reset_token = result.scalar_one_or_none()
    if reset_token:
        reset_token.used = True
        await db.commit()
```

### Task 5: Create email templates
**File**: `backend/app/templates/email/reset_password.html`

```html
<!DOCTYPE html>
<html>
<head>
    <style>
        body { font-family: Arial, sans-serif; line-height: 1.6; color: #333; }
        .container { max-width: 600px; margin: 0 auto; padding: 20px; }
        .button { 
            display: inline-block; 
            padding: 12px 24px; 
            background-color: #3b82f6; 
            color: white; 
            text-decoration: none; 
            border-radius: 5px; 
            margin: 20px 0;
        }
        .footer { margin-top: 30px; font-size: 12px; color: #666; }
    </style>
</head>
<body>
    <div class="container">
        <h2>Password Reset Request</h2>
        <p>Hello {{ first_name or email }},</p>
        <p>We received a request to reset your password. Click the button below to reset it:</p>
        <a href="{{ reset_url }}" class="button">Reset Password</a>
        <p>Or copy and paste this link into your browser:</p>
        <p>{{ reset_url }}</p>
        <p>This link will expire in 24 hours.</p>
        <p>If you didn't request this, please ignore this email.</p>
        <div class="footer">
            <p>Best regards,<br>Full-Stack Boilerplate Team</p>
        </div>
    </div>
</body>
</html>
```

### Task 6: Add email service method
**File**: `backend/app/core/email.py` (additions)

```python
async def send_password_reset_email(to_email: str, first_name: str, reset_url: str) -> None:
    """Send password reset email."""
    from fastapi_mail import MessageSchema, MessageType
    from pathlib import Path
    
    # Load template
    template_path = Path(__file__).parent.parent / "templates" / "email" / "reset_password.html"
    template_content = template_path.read_text()
    
    # Render template (simple string replacement for now)
    html_content = template_content.replace("{{ first_name }}", first_name or "")
    html_content = html_content.replace("{{ email }}", to_email)
    html_content = html_content.replace("{{ reset_url }}", reset_url)
    
    message = MessageSchema(
        subject="Password Reset Request",
        recipients=[to_email],
        body=html_content,
        subtype=MessageType.html,
    )
    
    await fastmail.send_message(message)
```

### Task 7: Add auth endpoints
**File**: `backend/app/api/api_v1/endpoints/auth.py` (additions)

```python
@router.post("/forgot-password", status_code=status.HTTP_204_NO_CONTENT)
async def forgot_password(
    request_data: ForgotPasswordRequest,
    db: AsyncSession = Depends(get_db),
) -> None:
    """Request password reset email."""
    # Find user by email
    result = await db.execute(select(User).where(User.email == request_data.email))
    user = result.scalar_one_or_none()
    
    # Always return 204 to prevent email enumeration
    if not user:
        return
    
    # Create reset token
    token = await create_reset_token(user.id, db)
    
    # Generate reset URL
    frontend_url = settings.FRONTEND_URL or "http://localhost:5173"
    reset_url = f"{frontend_url}/reset-password?token={token}"
    
    # Send email (async via Celery)
    await send_password_reset_email(user.email, user.first_name, reset_url)
    
    logger.info(f"Password reset requested for: {user.email}")


@router.post("/reset-password", status_code=status.HTTP_204_NO_CONTENT)
async def reset_password(
    reset_data: ResetPasswordRequest,
    db: AsyncSession = Depends(get_db),
) -> None:
    """Reset password with token."""
    # Validate token
    user = await validate_reset_token(reset_data.token, db)
    
    if not user:
        raise HTTPException(
            status_code=status.HTTP_400_BAD_REQUEST,
            detail="Invalid or expired token",
        )
    
    # Update password
    user.hashed_password = get_password_hash(reset_data.new_password)
    
    # Mark token as used
    await mark_token_used(reset_data.token, db)
    
    await db.commit()
    
    logger.info(f"Password reset completed for: {user.email}")
```

### Task 8: Environment configuration
Add to `.env.example`:
```
# Frontend URL (for password reset links)
FRONTEND_URL=http://localhost:5173

# Email configuration (required for password reset)
MAIL_USERNAME=your-email@gmail.com
MAIL_PASSWORD=your-app-password
MAIL_FROM=noreply@example.com
MAIL_PORT=587
MAIL_SERVER=smtp.gmail.com
```

---

## Frontend Tasks

### Task 9: Update Login page
**File**: `frontend/src/pages/Login.tsx`

Add "Forgot password?" link:
```tsx
<p className="text-center mt-4 text-sm">
  Don't have an account?{" "}
  <Link to="/register" className="text-primary hover:underline">
    Register
  </Link>
</p>
<p className="text-center mt-2 text-sm">
  <Link to="/forgot-password" className="text-muted-foreground hover:text-foreground">
    Forgot password?
  </Link>
</p>
```

### Task 10: Create ForgotPassword page
**File**: `frontend/src/pages/ForgotPassword.tsx`

```tsx
// Simple form with email input
// Shows success message after submission
// No error on invalid email (security)
```

### Task 11: Create ResetPassword page
**File**: `frontend/src/pages/ResetPassword.tsx`

```tsx
// Reads token from URL query param
// Validates token on mount
// Shows new password form
// Shows success/error states
```

### Task 12: Update App.tsx routes
Add routes:
```tsx
<Route path="/forgot-password" element={<ForgotPassword />} />
<Route path="/reset-password" element={<ResetPassword />} />
```

---

## Security Considerations

1. **Email Enumeration Prevention**: Always return 204, even if email doesn't exist
2. **Token Expiration**: 24 hours max
3. **Token Single Use**: Mark as used after successful reset
4. **Secure Token**: Use secrets.token_urlsafe(32)
5. **HTTPS Only**: Reset links should use HTTPS in production
6. **Rate Limiting**: Consider rate limiting on forgot-password endpoint

---

## Testing Checklist

- [ ] Request reset email (valid email)
- [ ] Request reset email (invalid email - no error shown)
- [ ] Click reset link in email
- [ ] Reset password with valid token
- [ ] Try using same token again (should fail)
- [ ] Try expired token (should fail)
- [ ] Login with new password
- [ ] Old password no longer works
- [ ] Email received with correct styling
- [ ] Mobile responsiveness of reset pages

---

## Definition of Done

- [ ] All 12 tasks complete
- [ ] Database migrated
- [ ] Email sending tested
- [ ] Frontend pages working
- [ ] Security review passed
- [ ] Git tag v0.1.2 created
- [ ] README updated with email configuration

---

## Implementation Order

```
Wave 1: Backend Foundation
├── Task 1: Create PasswordResetToken model
├── Task 2: Create Alembic migration
├── Task 3: Create schemas
└── Task 4: Create password reset service

Wave 2: Email Integration
├── Task 5: Create email templates
├── Task 6: Add email service method
└── Task 7: Add auth endpoints

Wave 3: Frontend
├── Task 8: Environment configuration
├── Task 9: Update Login page
├── Task 10: Create ForgotPassword page
├── Task 11: Create ResetPassword page
└── Task 12: Update App.tsx routes

Wave 4: Testing & Release
├── Test all scenarios
├── Update documentation
└── Tag v0.1.2
```
